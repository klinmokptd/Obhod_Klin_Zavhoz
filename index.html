<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анкета административно-хозяйственного обхода</title>
    <style>
        :root {
            --primary-color: #8B4513;
            --secondary-color: #CD853F;
            --light-color: #FAF0E6;
            --border-color: #ddd;
            --completed-color: #e6f7e6;
            --issue-color: #ffebee;
            --issue-border: #ffcdd2;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%238B4513' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin: 0;
            font-weight: bold;
        }
        
        .branch-info {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            line-height: 1.6;
        }
        
        .branch-name {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .branch-details {
            font-size: 1rem;
        }
        
        .timestamp {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .timestamp label {
            font-weight: bold;
        }
        
        .timestamp input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .auto-save-status {
            margin-left: auto;
            font-size: 0.9rem;
            color: #666;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .section {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .section.collapsed {
            max-height: 60px;
        }
        
        .section.expanded {
            max-height: 800px;
        }
        
        .section-header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header h2 {
            margin: 0;
            font-size: 1.1rem;
            flex: 1;
        }
        
        .section-content {
            padding: 15px;
            max-height: 600px;
            overflow-y: auto;
            display: none;
        }
        
        .section.expanded .section-content {
            display: block;
        }
        
        .question {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 3px solid var(--secondary-color);
            background-color: #f9f9f9;
            transition: all 0.3s;
            position: relative;
        }
        
        .question.completed {
            background-color: var(--completed-color);
        }
        
        .question.has-issue {
            background-color: var(--issue-color);
            border-left-color: var(--issue-border);
        }
        
        .question-text {
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 1rem;
            padding-right: 50px;
        }
        
        .check-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .check-button.checked {
            background-color: #4CAF50;
            border-color: #4CAF50;
        }
        
        .check-button.checked::after {
            content: "✓";
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .comment {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            min-height: 60px;
            font-size: 0.9rem;
            overflow: hidden;
            transition: height 0.2s;
        }
        
        .date-input {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
            display: none;
        }
        
        .date-input.visible {
            display: block;
        }
        
        .section-status {
            font-size: 0.8rem;
            background-color: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 20px;
        }
        
        button {
            padding: 12px 30px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #6b3300;
        }
        
        .save-btn {
            background-color: #4CAF50;
        }
        
        .save-btn:hover {
            background-color: #3d8b40;
        }
        
        .export-btn {
            background-color: #ff9800;
        }
        
        .export-btn:hover {
            background-color: #e68900;
        }
        
        .clear-btn {
            background-color: #f44336;
        }
        
        .clear-btn:hover {
            background-color: #d32f2f;
        }
        
        @media (max-width: 768px) {
            .sections-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header h2 {
                font-size: 1rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Анкета административно-хозяйственного обхода</h1>
            <p class="subtitle">с заведующим хозяйством</p>
        </header>
        
        <div class="branch-info">
            <div class="branch-name">ГБУЗ МО МОКПТД</div>
            <div class="branch-details">Филиал "Клинский"</div>
            <div class="branch-details">Клинское отделение</div>
        </div>
        
        <div class="timestamp">
            <label for="timestamp">Дата проверки:</label>
            <input type="date" id="timestamp" name="timestamp">
            <div class="auto-save-status" id="auto-save-status">Автосохранение включено</div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        
        <div class="sections-grid" id="sections-container">
            <!-- Секции будут сгенерированы автоматически -->
        </div>
        
        <div class="controls">
            <button id="save-btn" class="save-btn">Сохранить данные</button>
            <button id="export-btn" class="export-btn">Скачать Excel файл</button>
            <button id="clear-btn" class="clear-btn">Очистить форму</button>
        </div>
    </div>

    <script>
        // Полные данные анкеты из Excel файла (точное соответствие)
        const sections = [
            {
                title: "Входная группа детского отделения",
                questions: [
                    "Ступеньки, перила технически исправны, не требуют ремонта",
                    "Ступеньки и территория рядом посыпаны реагентом",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Покрытие дверей не требует покраски",
                    "Дверь в исправном состоянии (замки, доводчик, петли)",
                    "Санитарное состояние удовлетворительно (нет пыли, мусора, паутины)",
                    "Состояние мусорной урны удовлетворительное",
                    "Информация на входной группе соответствует нормативу",
                    "Освещение исправно",
                    "Кнопка вызова персонала работает",
                    "В наличии ведро с песком; совок привязан",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Контейнерная площадка",
                questions: [
                    "Общий порядок поддерживается",
                    "Территория рядом посыпана реагентом",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Информация соответствует нормативу",
                    "Доступ ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Лишние предметы отсутствуют",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Входная группа в мокротную",
                questions: [
                    "Ступеньки, перила технически исправны, не требуют ремонта",
                    "Ступеньки и территория рядом посыпаны реагентом",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Покрытие дверей не требует покраски",
                    "Дверь в исправном состоянии (замки, доводчик, петли)",
                    "Санитарное состояние удовлетворительно (нет пыли, мусора, паутины)",
                    "Состояние мусорной урны удовлетворительное",
                    "Информация соответствует нормативу",
                    "Освещение исправно",
                    "Наличие ведра с песком с привязанным совком",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Состояние фасадов здания",
                questions: [
                    "Окна и подоконники чистые",
                    "Фундамент (надземная часть) не требует ремонта",
                    "Окна цокольного этажа чистые",
                    "Защитные экраны чистые, не требуют покраски",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Газоны",
                questions: [
                    "Соответствуют нормативам",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Асфальтовое покрытие",
                questions: [
                    "Не требует ремонта/чистки",
                    "Обработано реагентом",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Входная группа взрослого отделения",
                questions: [
                    "Ступеньки, перила технически исправны, не требуют ремонта",
                    "Ступеньки и территория рядом посыпаны реагентом",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Покрытие дверей не требует покраски",
                    "Дверь в исправном состоянии (замки, доводчик, петли)",
                    "Санитарное состояние удовлетворительно (нет пыли, мусора, паутины)",
                    "Состояние мусорной урны удовлетворительное",
                    "Информация соответствует нормативу",
                    "Освещение исправно",
                    "Кнопка вызова персонала работает",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Входная группа в мокротную внутренняя часть",
                questions: [
                    "Общий порядок поддерживается",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Вывеска 'Выход' светится",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Помещение мокротной",
                questions: [
                    "Общий порядок поддерживается",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Рекреация цокольного этажа",
                questions: [
                    "Общий порядок поддерживается",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Склад",
                questions: [
                    "Общий порядок поддерживается",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Столовая",
                questions: [
                    "Общий порядок поддерживается",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Столовые приборы хранятся в отдельных контейнерах",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Гардероб",
                questions: [
                    "Общий порядок поддерживается",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Коридор цокольного этажа",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии"
                ]
            },
            {
                title: "Предбанник туалета",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Страховочный ключ вставлен в замок",
                    "Розетки и электропроводка исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Помещение туалета",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Кабинет заведующего отделением",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Кабинет заведующего филиалом",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Входная группа детского отделения (внутренняя часть)",
                questions: [
                    "Общий порядок поддерживается",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Вывеска 'Выход' светится",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Рекреация детского отделения",
                questions: [
                    "Общий порядок поддерживается",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Вывеска 'Выход' светится",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Кабинет педиатра",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Процедурный детский кабинет",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Архив",
                questions: [
                    "Общий порядок поддерживается",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Рекреация взрослого отделения",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Вывеска 'Выход' светится",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Процедурный кабинет взрослый",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Розетки и электропроводка исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Рентгенкабинет",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Кабинет старшей медицинской сестры",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Регистратура",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Работоспособность запирающего регистратуру устройства",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Кабинет приема врача 102",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Туалет для персонала",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы отсутствуют",
                    "Сантехника в исправном состоянии",
                    "Кнопка вызова персонала работает",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Кабинет приема врача 103",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Входная группа взрослого отделения (внутренняя часть)",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Доступ в служебные помещения, шкафы ограничен",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы и мебель отсутствуют",
                    "Мебель в исправном состоянии",
                    "Вывеска 'Выход' светится",
                    "Кресло-каталка в исправном состоянии, чистая",
                    "Выключатели и розетки подписаны",
                    "Выключатели, розетки удлинители, сетевые фильтры исправны",
                    "Дополнительная информация"
                ]
            },
            {
                title: "Туалет для посетителей",
                questions: [
                    "Общий порядок поддерживается",
                    "Стены, окна и двери чистые",
                    "Напольное покрытие целое, ровное, не требует ремонта",
                    "Состояние потолка удовлетворительное",
                    "Стены не требуют косметического ремонта",
                    "Освещение яркое, исправно работает",
                    "Информация соответствуют нормам",
                    "Ленты на ступенях/порогах не требуют обновления",
                    "Двери в исправном состоянии (замки, доводчик, петли)",
                    "Выключатели и розетки подписаны",
                    "Лишние предметы отсутствуют",
                    "Сантехника в исправном состоянии",
                    "Кнопка вызова персонала работает",
                    "Поручни закреплены",
                    "Крючки для костылей закреплены",
                    "Дополнительная информация"
                ]
            }
        ];

        // Глобальные переменные
        let answers = {};
        let autoSaveInterval;
        let lastSaveTime = null;
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Установка текущей даты (без времени)
            const now = new Date();
            
            const timestampInput = document.getElementById('timestamp');
            // Форматируем дату для input[type="date"]
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            
            timestampInput.value = `${year}-${month}-${day}`;
            
            // Генерация секций
            generateSections();
            
            // Обновление прогресс-бара
            updateProgressBar();
            
            // Обработчики событий для кнопок
            document.getElementById('save-btn').addEventListener('click', saveToLocalStorage);
            document.getElementById('export-btn').addEventListener('click', exportToExcel);
            document.getElementById('clear-btn').addEventListener('click', clearForm);
            
            // Загрузка сохраненных данных
            loadFromLocalStorage();
            
            // Запуск автосохранения каждые 3 минуты
            startAutoSave();
            
            // Автоматическое увеличение полей комментариев
            setupAutoResizeTextareas();
        });
        
        // Настройка автоматического изменения размера textarea
        function setupAutoResizeTextareas() {
            document.querySelectorAll('.comment').forEach(textarea => {
                // Устанавливаем начальную высоту
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
                
                // Обработчик изменения содержимого
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                    
                    const questionId = this.dataset.questionId;
                    const [sectionIndex, questionIndex] = questionId.split('-').map(Number);
                    const questionElement = document.querySelector(`[data-question-id="${sectionIndex}-${questionIndex}"]`);
                    
                    if (questionElement) {
                        const checkButton = questionElement.querySelector('.check-button');
                        const dateInput = questionElement.querySelector('.date-input');
                        
                        if (this.value.trim() !== '') {
                            // Есть комментарий - снимаем галочку
                            if (checkButton.classList.contains('checked')) {
                                checkButton.classList.remove('checked');
                                questionElement.classList.remove('completed');
                            }
                            
                            // Показываем поле даты
                            if (dateInput) {
                                dateInput.classList.add('visible');
                            }
                            
                            questionElement.classList.add('has-issue');
                            updateQuestionStatus(sectionIndex, questionIndex, 'has_comment');
                        } else {
                            // Комментарий удалён
                            if (dateInput) {
                                dateInput.classList.remove('visible');
                            }
                            
                            questionElement.classList.remove('has-issue');
                            updateQuestionStatus(sectionIndex, questionIndex, 'no_comment');
                        }
                        
                        updateSectionStatus(sectionIndex);
                        updateProgressBar();
                        saveAnswer(sectionIndex, questionIndex, null, this.value);
                        saveToLocalStorage(true);
                    }
                });
            });
        }
        
        // Запуск автосохранения
        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                saveToLocalStorage(true);
            }, 3 * 60 * 1000); // 3 минуты
        }
        
        // Генерация секций анкеты
        function generateSections() {
            const container = document.getElementById('sections-container');
            
            sections.forEach((section, index) => {
                const sectionElement = document.createElement('div');
                sectionElement.className = 'section collapsed';
                sectionElement.dataset.sectionIndex = index;
                
                // Заголовок секции
                const header = document.createElement('div');
                header.className = 'section-header';
                header.dataset.sectionIndex = index;
                
                const title = document.createElement('h2');
                title.textContent = section.title;
                
                const status = document.createElement('div');
                status.className = 'section-status';
                status.textContent = '0/' + section.questions.length;
                
                header.appendChild(title);
                header.appendChild(status);
                
                // Содержимое секции
                const content = document.createElement('div');
                content.className = 'section-content';
                
                section.questions.forEach((question, qIndex) => {
                    const questionElement = document.createElement('div');
                    questionElement.className = 'question';
                    questionElement.dataset.questionId = `${index}-${qIndex}`;
                    
                    const questionText = document.createElement('div');
                    questionText.className = 'question-text';
                    questionText.textContent = question;
                    
                    const checkButton = document.createElement('div');
                    checkButton.className = 'check-button';
                    checkButton.dataset.questionId = `${index}-${qIndex}`;
                    
                    questionElement.appendChild(questionText);
                    questionElement.appendChild(checkButton);
                    
                    // Поле для комментария для всех вопросов
                    const comment = document.createElement('textarea');
                    comment.className = 'comment';
                    comment.placeholder = question === "Дополнительная информация" ? 'Дополнительная информация' : 'Комментарий (необязательно)';
                    comment.dataset.questionId = `${index}-${qIndex}`;
                    
                    questionElement.appendChild(comment);
                    
                    // Поле для даты устранения
                    const dateInput = document.createElement('input');
                    dateInput.type = 'date';
                    dateInput.className = 'date-input';
                    dateInput.dataset.questionId = `${index}-${qIndex}`;
                    
                    questionElement.appendChild(dateInput);
                    
                    content.appendChild(questionElement);
                    
                    // Обработчик для кнопки проверки
                    checkButton.addEventListener('click', function() {
                        const questionId = this.dataset.questionId;
                        const [sectionIndex, questionIndex] = questionId.split('-').map(Number);
                        const questionElement = document.querySelector(`[data-question-id="${sectionIndex}-${questionIndex}"]`);
                        const comment = questionElement.querySelector('.comment');
                        const dateInput = questionElement.querySelector('.date-input');
                        
                        if (this.classList.contains('checked')) {
                            // Снимаем галочку
                            this.classList.remove('checked');
                            questionElement.classList.remove('completed');
                            questionElement.classList.remove('has-issue');
                            
                            // Очищаем комментарий
                            comment.value = '';
                            comment.style.height = '60px';
                            
                            // Скрываем дату
                            dateInput.classList.remove('visible');
                            dateInput.value = '';
                            
                            updateQuestionStatus(sectionIndex, questionIndex, 'unchecked');
                        } else {
                            // Ставим галочку
                            this.classList.add('checked');
                            questionElement.classList.add('completed');
                            questionElement.classList.remove('has-issue');
                            
                            // Очищаем комментарий
                            comment.value = '';
                            comment.style.height = '60px';
                            
                            // Скрываем дату
                            dateInput.classList.remove('visible');
                            dateInput.value = '';
                            
                            updateQuestionStatus(sectionIndex, questionIndex, 'checked');
                        }
                        
                        updateSectionStatus(sectionIndex);
                        updateProgressBar();
                        saveToLocalStorage(true);
                    });
                    
                    // Обработчик для поля комментария
                    comment.addEventListener('input', function() {
                        const questionId = this.dataset.questionId;
                        const [sectionIndex, questionIndex] = questionId.split('-').map(Number);
                        const questionElement = document.querySelector(`[data-question-id="${sectionIndex}-${questionIndex}"]`);
                        const checkButton = questionElement.querySelector('.check-button');
                        const dateInput = questionElement.querySelector('.date-input');
                        
                        if (this.value.trim() !== '') {
                            // Есть комментарий - снимаем галочку
                            if (checkButton.classList.contains('checked')) {
                                checkButton.classList.remove('checked');
                                questionElement.classList.remove('completed');
                            }
                            
                            // Показываем поле даты
                            dateInput.classList.add('visible');
                            questionElement.classList.add('has-issue');
                            
                            updateQuestionStatus(sectionIndex, questionIndex, 'has_comment');
                        } else {
                            // Комментарий удалён
                            dateInput.classList.remove('visible');
                            questionElement.classList.remove('has-issue');
                            updateQuestionStatus(sectionIndex, questionIndex, 'no_comment');
                        }
                        
                        updateSectionStatus(sectionIndex);
                        updateProgressBar();
                        saveAnswer(sectionIndex, questionIndex, null, this.value);
                        saveToLocalStorage(true);
                    });
                    
                    // Обработчик для поля даты
                    dateInput.addEventListener('change', function() {
                        const questionId = this.dataset.questionId;
                        const [sectionIndex, questionIndex] = questionId.split('-').map(Number);
                        
                        saveAnswer(sectionIndex, questionIndex, null, null, this.value);
                        saveToLocalStorage(true);
                    });
                });
                
                sectionElement.appendChild(header);
                sectionElement.appendChild(content);
                
                // Обработчик для переключения секций
                header.addEventListener('click', function() {
                    const sectionIndex = this.dataset.sectionIndex;
                    const section = document.querySelector(`.section[data-section-index="${sectionIndex}"]`);
                    
                    if (section.classList.contains('collapsed')) {
                        // Закрыть все секции
                        document.querySelectorAll('.section').forEach(s => {
                            s.classList.remove('expanded');
                            s.classList.add('collapsed');
                        });
                        // Открыть текущую
                        section.classList.remove('collapsed');
                        section.classList.add('expanded');
                        
                        // Прокрутить к заголовку секции
                        setTimeout(() => {
                            section.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start'
                            });
                        }, 100);
                    } else {
                        // Закрыть текущую
                        section.classList.remove('expanded');
                        section.classList.add('collapsed');
                    }
                    
                    // После открытия секции обновить размер textarea
                    setTimeout(() => {
                        setupAutoResizeTextareas();
                    }, 100);
                });
                
                container.appendChild(sectionElement);
            });
        }
        
        // Обновить статус вопроса
        function updateQuestionStatus(sectionIndex, questionIndex, action) {
            if (!answers[sectionIndex]) {
                answers[sectionIndex] = {};
            }
            
            if (!answers[sectionIndex][questionIndex]) {
                answers[sectionIndex][questionIndex] = {};
            }
            
            switch(action) {
                case 'checked':
                    answers[sectionIndex][questionIndex].status = 'checked';
                    break;
                case 'unchecked':
                    answers[sectionIndex][questionIndex].status = 'unchecked';
                    break;
                case 'has_comment':
                    answers[sectionIndex][questionIndex].status = 'has_comment';
                    break;
                case 'no_comment':
                    answers[sectionIndex][questionIndex].status = 'unchecked';
                    break;
            }
        }
        
        // Сохранить ответ
        function saveAnswer(sectionIndex, questionIndex, status, comment = null, date = null) {
            if (!answers[sectionIndex]) {
                answers[sectionIndex] = {};
            }
            
            if (!answers[sectionIndex][questionIndex]) {
                answers[sectionIndex][questionIndex] = {};
            }
            
            if (status !== null) {
                answers[sectionIndex][questionIndex].status = status;
            }
            
            if (comment !== null) {
                answers[sectionIndex][questionIndex].comment = comment;
            }
            
            if (date !== null) {
                answers[sectionIndex][questionIndex].date = date;
            }
        }
        
        // Получить статус для отображения
        function getStatus(sectionIndex, questionIndex) {
            if (!answers[sectionIndex] || !answers[sectionIndex][questionIndex]) {
                return "Не проверено";
            }
            
            const answer = answers[sectionIndex][questionIndex];
            
            if (answer.status === 'checked') {
                return "Без замечаний";
            } else if (answer.comment && answer.comment.trim() !== '') {
                return "Выявлены замечания";
            } else {
                return "Не проверено";
            }
        }
        
        // Обновить статус секции
        function updateSectionStatus(sectionIndex) {
            const section = document.querySelector(`.section[data-section-index="${sectionIndex}"]`);
            const statusElement = section.querySelector('.section-status');
            
            let checkedCount = 0;
            let totalQuestions = sections[sectionIndex].questions.length;
            
            // Подсчитываем проверенные вопросы (с галочкой или с комментарием)
            for (let i = 0; i < totalQuestions; i++) {
                const questionElement = document.querySelector(`[data-question-id="${sectionIndex}-${i}"]`);
                if (questionElement) {
                    const checkButton = questionElement.querySelector('.check-button');
                    const comment = questionElement.querySelector('.comment');
                    
                    if (checkButton.classList.contains('checked') || 
                        (comment && comment.value.trim() !== '')) {
                        checkedCount++;
                    }
                }
            }
            
            statusElement.textContent = `${checkedCount}/${totalQuestions}`;
        }
        
        // Обновить прогресс-бар
        function updateProgressBar() {
            const progressBar = document.getElementById('progress');
            
            let totalQuestions = 0;
            let checkedQuestions = 0;
            
            sections.forEach((section, index) => {
                totalQuestions += section.questions.length;
                
                for (let i = 0; i < section.questions.length; i++) {
                    const questionElement = document.querySelector(`[data-question-id="${index}-${i}"]`);
                    if (questionElement) {
                        const checkButton = questionElement.querySelector('.check-button');
                        const comment = questionElement.querySelector('.comment');
                        
                        if (checkButton.classList.contains('checked') || 
                            (comment && comment.value.trim() !== '')) {
                            checkedQuestions++;
                        }
                    }
                }
            });
            
            const progressPercentage = totalQuestions > 0 ? (checkedQuestions / totalQuestions) * 100 : 0;
            progressBar.style.width = `${progressPercentage}%`;
        }
        
        // Сохранить в LocalStorage
        function saveToLocalStorage(silent = false) {
            // Сохраняем состояние кнопок и комментариев
            document.querySelectorAll('.question').forEach(questionElement => {
                const questionId = questionElement.dataset.questionId;
                const [sectionIndex, questionIndex] = questionId.split('-').map(Number);
                
                const checkButton = questionElement.querySelector('.check-button');
                const comment = questionElement.querySelector('.comment');
                const dateInput = questionElement.querySelector('.date-input');
                
                let status = 'unchecked';
                if (checkButton.classList.contains('checked')) {
                    status = 'checked';
                } else if (comment && comment.value.trim() !== '') {
                    status = 'has_comment';
                }
                
                saveAnswer(sectionIndex, questionIndex, status, comment ? comment.value : '', dateInput ? dateInput.value : '');
            });
            
            const timestamp = document.getElementById('timestamp').value;
            const data = {
                timestamp: timestamp,
                answers: answers,
                lastSaved: new Date().toLocaleString('ru-RU')
            };
            
            localStorage.setItem('medical_checklist_data', JSON.stringify(data));
            lastSaveTime = new Date();
            
            if (!silent) {
                alert('Данные сохранены в браузере!');
            }
            
            updateAutoSaveStatus();
        }
        
        // Обновить статус автосохранения
        function updateAutoSaveStatus() {
            const statusElement = document.getElementById('auto-save-status');
            if (lastSaveTime) {
                const timeString = lastSaveTime.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                statusElement.textContent = `Сохранено: ${timeString}`;
            }
        }
        
        // Загрузить из LocalStorage
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('medical_checklist_data');
            if (savedData) {
                const data = JSON.parse(savedData);
                answers = data.answers || {};
                
                // Восстановить ответы в интерфейсе
                Object.keys(answers).forEach(sectionIndex => {
                    Object.keys(answers[sectionIndex]).forEach(questionIndex => {
                        const answerData = answers[sectionIndex][questionIndex];
                        const questionElement = document.querySelector(`[data-question-id="${sectionIndex}-${questionIndex}"]`);
                        
                        if (questionElement) {
                            const checkButton = questionElement.querySelector('.check-button');
                            const comment = questionElement.querySelector('.comment');
                            const dateInput = questionElement.querySelector('.date-input');
                            
                            if (answerData.status === 'checked') {
                                checkButton.classList.add('checked');
                                questionElement.classList.add('completed');
                            } else if (answerData.status === 'has_comment' && answerData.comment && answerData.comment.trim() !== '') {
                                // Восстанавливаем комментарий
                                if (comment) {
                                    comment.value = answerData.comment;
                                    comment.style.height = 'auto';
                                    comment.style.height = (comment.scrollHeight) + 'px';
                                    
                                    // Показываем поле даты
                                    if (dateInput) {
                                        dateInput.classList.add('visible');
                                        if (answerData.date) {
                                            dateInput.value = answerData.date;
                                        }
                                    }
                                    
                                    questionElement.classList.add('has-issue');
                                }
                            }
                        }
                    });
                    updateSectionStatus(parseInt(sectionIndex));
                });
                
                updateProgressBar();
                updateAutoSaveStatus();
                
                // Обновить размер textarea после загрузки данных
                setTimeout(() => {
                    setupAutoResizeTextareas();
                }, 100);
            }
        }
        
        // Очистить форму
        function clearForm() {
            if (confirm('Вы уверены, что хотите очистить всю форму? Все данные будут удалены.')) {
                answers = {};
                localStorage.removeItem('medical_checklist_data');
                
                // Сбросить интерфейс
                document.querySelectorAll('.question').forEach(question => {
                    question.classList.remove('completed');
                    question.classList.remove('has-issue');
                    
                    const checkButtons = question.querySelectorAll('.check-button');
                    checkButtons.forEach(button => button.classList.remove('checked'));
                    
                    const comments = question.querySelectorAll('.comment');
                    comments.forEach(comment => {
                        comment.value = '';
                        comment.style.height = '60px';
                    });
                    
                    const dateInputs = question.querySelectorAll('.date-input');
                    dateInputs.forEach(input => {
                        input.classList.remove('visible');
                        input.value = '';
                    });
                });
                
                document.querySelectorAll('.section-status').forEach(status => {
                    const sectionIndex = status.closest('.section').dataset.sectionIndex;
                    status.textContent = `0/${sections[sectionIndex].questions.length}`;
                });
                
                updateProgressBar();
                updateAutoSaveStatus();
                
                alert('Форма очищена!');
            }
        }
        
        // Исправленная функция exportToExcel() с правильным форматом даты
function exportToExcel() {
    const timestamp = document.getElementById('timestamp').value;
    const dateObj = new Date(timestamp);
    
    // Форматируем дату как ДД.ММ.ГГГГ
    const day = String(dateObj.getDate()).padStart(2, '0');
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const year = dateObj.getFullYear();
    const formattedDate = `${day}.${month}.${year}`;
    
    // Создаем рабочую книгу
    const wb = XLSX.utils.book_new();
    
    // Создаем данные для Excel
    let excelData = [];
    
    // Заголовок документа
    excelData.push(["Анкета административно-хозяйственного обхода с заведующим хозяйством"]);
    excelData.push(["ГБУЗ МО МОКПТД"]);
    excelData.push(["Филиал \"Клинский\""]);
    excelData.push(["Клинское отделение"]);
    excelData.push([`Дата проверки: ${formattedDate}`]);
    excelData.push([]);
    
    let globalRowNumber = 1;
    
    // Добавляем данные по секциям
    sections.forEach((section, sectionIndex) => {
        excelData.push([section.title]);
        // Колонка № видимая - для восстановления порядка после фильтрации
        excelData.push(["№", "Вопрос", "Статус", "Комментарий", "Сроки устранения"]);
        
        section.questions.forEach((question, questionIndex) => {
            const answerData = answers[sectionIndex] && answers[sectionIndex][questionIndex];
            const status = getStatus(sectionIndex, questionIndex);
            const comment = answerData && answerData.comment ? answerData.comment : '';
            
            // Форматируем дату устранения (если есть)
            let dueDate = '';
            if (answerData && answerData.date) {
                const dueDateObj = new Date(answerData.date);
                const dueDay = String(dueDateObj.getDate()).padStart(2, '0');
                const dueMonth = String(dueDateObj.getMonth() + 1).padStart(2, '0');
                const dueYear = dueDateObj.getFullYear();
                dueDate = `${dueDay}.${dueMonth}.${dueYear}`;
            }
            
            excelData.push([globalRowNumber, question, status, comment, dueDate]);
            globalRowNumber++;
        });
        
        excelData.push([]);
    });
    
    // Создаем рабочий лист
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    
    // Настраиваем ширину колонок
    const colWidths = [
        {wch: 8},   // № (для сортировки)
        {wch: 50},  // Вопрос
        {wch: 20},  // Статус
        {wch: 40},  // Комментарий
        {wch: 12}   // Сроки устранения (уже помещается ДД.ММ.ГГГГ)
    ];
    
    ws['!cols'] = colWidths;
    
    // Добавляем условное форматирование (красный фон для строк с замечаниями)
    const range = XLSX.utils.decode_range(ws['!ref']);
    
    for (let R = 7; R <= range.e.r; R++) {
        const statusCell = ws[XLSX.utils.encode_cell({r:R, c:2})]; // Колонка C (Статус)
        
        if (statusCell && statusCell.v === "Выявлены замечания") {
            // Устанавливаем красный фон для ВСЕЙ строки
            for (let C = 0; C <= 4; C++) { // 5 колонок: №, Вопрос, Статус, Комментарий, Сроки
                const cellAddress = XLSX.utils.encode_cell({r:R, c:C});
                if (!ws[cellAddress]) continue;
                
                if (!ws[cellAddress].s) {
                    ws[cellAddress].s = {};
                }
                
                ws[cellAddress].s.fill = {
                    fgColor: {rgb: "FFFF9999"} // Красный цвет
                };
            }
        }
    }
    
    // Добавляем стиль для заголовка секций (жирный)
    let sectionRow = 6; // Первая строка с названием секции
    for (let i = 0; i < sections.length; i++) {
        const cellAddress = XLSX.utils.encode_cell({r:sectionRow, c:0});
        if (ws[cellAddress]) {
            if (!ws[cellAddress].s) ws[cellAddress].s = {};
            ws[cellAddress].s.font = {bold: true};
        }
        
        // Вычисляем следующую секцию
        sectionRow += sections[i].questions.length + 3; // + вопросы + заголовок + пустая строка
    }
    
    // Жирный шрифт для заголовков колонок
    for (let i = 0; i < sections.length; i++) {
        const headerRow = 7 + i * (sections[i].questions.length + 3); // Строка с заголовками
        for (let C = 0; C <= 4; C++) {
            const cellAddress = XLSX.utils.encode_cell({r:headerRow, c:C});
            if (ws[cellAddress]) {
                if (!ws[cellAddress].s) ws[cellAddress].s = {};
                ws[cellAddress].s.font = {bold: true};
                ws[cellAddress].s.fill = {
                    fgColor: {rgb: "FFE0E0E0"} // Светло-серый фон
                };
            }
        }
    }
    
    // Добавляем рабочий лист в книгу
    XLSX.utils.book_append_sheet(wb, ws, "Анкета");
    
    // Генерируем файл и скачиваем
    const fileName = `анкета_хозяйственного_обхода_${formattedDate.replace(/\./g, '-')}.xlsx`;
    XLSX.writeFile(wb, fileName);
}
    </script>
</body>
</html>
