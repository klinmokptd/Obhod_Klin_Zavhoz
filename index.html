<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анкета административно-хозяйственного обхода</title>
    <style>
        :root {
            --primary-color: #8B4513;
            --secondary-color: #CD853F;
            --light-color: #FAF0E6;
            --border-color: #ddd;
            --completed-color: #e6f7e6;
            --issue-color: #ffebee;
            --issue-border: #ffcdd2;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%238B4513' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin: 0;
            font-weight: bold;
        }
        
        .branch-info {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            line-height: 1.6;
        }
        
        .branch-name {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .branch-details {
            font-size: 1rem;
        }
        
        .timestamp {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .timestamp label {
            font-weight: bold;
        }
        
        .timestamp input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .auto-save-status {
            margin-left: auto;
            font-size: 0.9rem;
            color: #666;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .section {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .section.collapsed {
            max-height: 60px;
        }
        
        .section.expanded {
            max-height: 800px;
        }
        
        .section-header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header h2 {
            margin: 0;
            font-size: 1.1rem;
            flex: 1;
        }
        
        .section-content {
            padding: 15px;
            max-height: 600px;
            overflow-y: auto;
            display: none;
        }
        
        .section.expanded .section-content {
            display: block;
        }
        
        .question {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 3px solid var(--secondary-color);
            background-color: #f9f9f9;
            transition: all 0.3s;
            position: relative;
        }
        
        .question.completed {
            background-color: var(--completed-color);
        }
        
        .question.has-issue {
            background-color: var(--issue-color);
            border-left-color: var(--issue-border);
        }
        
        .question-text {
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 1rem;
            padding-right: 50px;
        }
        
        .check-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .check-button.checked {
            background-color: #4CAF50;
            border-color: #4CAF50;
        }
        
        .check-button.checked::after {
            content: "✓";
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .comment {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            min-height: 60px;
            font-size: 0.9rem;
            overflow: hidden;
            transition: height 0.2s;
        }
        
        .date-input {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
            display: none;
        }
        
        .date-input.visible {
            display: block;
        }
        
        .section-status {
            font-size: 0.8rem;
            background-color: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 20px;
        }
        
        button {
            padding: 12px 30px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #6b3300;
        }
        
        .save-btn {
            background-color: #4CAF50;
        }
        
        .save-btn:hover {
            background-color: #3d8b40;
        }
        
        .export-btn {
            background-color: #ff9800;
        }
        
        .export-btn:hover {
            background-color: #e68900;
        }
        
        .clear-btn {
            background-color: #f44336;
        }
        
        .clear-btn:hover {
            background-color: #d32f2f;
        }
        
        @media (max-width: 768px) {
            .sections-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header h2 {
                font-size: 1rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
    <script>
    // Полные данные анкеты из Excel файла
    const sections = [
        {
            title: "Входная группа детского отделения",
            questions: [
                "Ступеньки, перила технически исправны, не требуют ремонта",
                "Ступеньки и территория рядом посыпаны реагентом",
                "Ленты на ступенях/порогах не требуют обновления",
                "Покрытие дверей не требует покраски",
                "Дверь в исправном состоянии (замки, доводчик, петли)",
                "Санитарное состояние удовлетворительно (нет пыли, мусора, паутины)",
                "Состояние мусорной урны удовлетворительное",
                "Информация на входной группе соответствует нормативу",
                "Освещение исправно",
                "Кнопка вызова персонала работает",
                "В наличии ведро с песком; совок привязан",
                "Дополнительная информация"
            ],
            hasComment: true
        },
        {
            title: "Контейнерная площадка",
            questions: [
                "Общий порядок поддерживается",
                "Территория рядом посыпана реагентом",
                "Стены и двери чистые",
                "Напольное покрытие целое, ровное, не требует ремонта",
                "Состояние потолка удовлетворительное",
                "Стены не требуют косметического ремонта",
                "Информация соответствует нормативу",
                "Доступ ограничен",
                "Двери в исправном состоянии (замки, доводчик, петли)",
                "Лишние предметы отсутствуют",
                "Дополнительная информация"
            ],
            hasComment: true
        },
        // ... остальные секции остаются без изменений
    ];

    // Глобальные переменные
    let answers = {};
    let autoSaveInterval;
    let lastSaveTime = null;
    
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Установка текущей даты (без времени)
        const now = new Date();
        
        const timestampInput = document.getElementById('timestamp');
        // Форматируем дату для input[type="date"]
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        
        timestampInput.value = `${year}-${month}-${day}`;
        
        // Генерация секций
        generateSections();
        
        // Обновление прогресс-бара
        updateProgressBar();
        
        // Обработчики событий для кнопок
        document.getElementById('save-btn').addEventListener('click', saveToLocalStorage);
        document.getElementById('export-btn').addEventListener('click', exportToExcel);
        document.getElementById('clear-btn').addEventListener('click', clearForm);
        
        // Загрузка сохраненных данных
        loadFromLocalStorage();
        
        // Запуск автосохранения каждые 3 минуты
        startAutoSave();
        
        // Автоматическое увеличение полей комментариев
        setupAutoResizeTextareas();
    });
    
    // Настройка автоматического изменения размера textarea
    function setupAutoResizeTextareas() {
        document.querySelectorAll('.comment, .additional-info').forEach(textarea => {
            // Устанавливаем начальную высоту
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
            
            // Обработчик изменения содержимого
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        });
    }
    
    // Запуск автосохранения
    function startAutoSave() {
        autoSaveInterval = setInterval(() => {
            saveToLocalStorage(true);
        }, 3 * 60 * 1000); // 3 минуты
    }
    
    // Генерация секций анкеты
    function generateSections() {
        const container = document.getElementById('sections-container');
        
        sections.forEach((section, index) => {
            const sectionElement = document.createElement('div');
            sectionElement.className = 'section collapsed';
            sectionElement.dataset.sectionIndex = index;
            
            // Заголовок секции
            const header = document.createElement('div');
            header.className = 'section-header';
            header.dataset.sectionIndex = index;
            
            const title = document.createElement('h2');
            title.textContent = section.title;
            
            const status = document.createElement('div');
            status.className = 'section-status';
            status.textContent = '0/' + section.questions.length;
            
            header.appendChild(title);
            header.appendChild(status);
            
            // Содержимое секции
            const content = document.createElement('div');
            content.className = 'section-content';
            
            section.questions.forEach((question, qIndex) => {
                const questionElement = document.createElement('div');
                questionElement.className = 'question';
                questionElement.dataset.questionId = `${index}-${qIndex}`;
                
                const questionText = document.createElement('div');
                questionText.className = 'question-text';
                questionText.textContent = question;
                
                const checkButton = document.createElement('div');
                checkButton.className = 'check-button';
                checkButton.dataset.questionId = `${index}-${qIndex}`;
                
                questionElement.appendChild(questionText);
                questionElement.appendChild(checkButton);
                
                // Поле для комментария, если требуется и это не вопрос "Дополнительная информация"
                if (section.hasComment && question !== "Дополнительная информация") {
                    const comment = document.createElement('textarea');
                    comment.className = 'comment';
                    comment.placeholder = 'Комментарий (необязательно)';
                    comment.dataset.questionId = `${index}-${qIndex}`;
                    
                    questionElement.appendChild(comment);
                }
                
                // Поле для дополнительной информации
                if (question === "Дополнительная информация") {
                    const additionalInfo = document.createElement('textarea');
                    additionalInfo.className = 'additional-info';
                    additionalInfo.placeholder = 'Дополнительная информация';
                    additionalInfo.dataset.questionId = `${index}-${qIndex}`;
                    
                    questionElement.appendChild(additionalInfo);
                }
                
                content.appendChild(questionElement);
                
                // Обработчик для кнопки проверки
                checkButton.addEventListener('click', function() {
                    const isChecked = this.classList.contains('checked');
                    
                    if (isChecked) {
                        this.classList.remove('checked');
                        questionElement.classList.remove('completed');
                    } else {
                        this.classList.add('checked');
                        questionElement.classList.add('completed');
                    }
                    
                    updateSectionStatus(index);
                    updateProgressBar();
                    saveAnswer(index, qIndex, this.classList.contains('checked') ? 'Проверено' : 'Не проверено');
                    saveToLocalStorage(true);
                });
                
                // Обработчики для полей ввода
                if (section.hasComment && question !== "Дополнительная информация") {
                    const comment = questionElement.querySelector('textarea');
                    comment.addEventListener('input', function() {
                        saveAnswer(index, qIndex, null, this.value);
                        saveToLocalStorage(true);
                    });
                }
                
                if (question === "Дополнительная информация") {
                    const additionalInfo = questionElement.querySelector('textarea');
                    additionalInfo.addEventListener('input', function() {
                        saveAnswer(index, qIndex, null, null, this.value);
                        saveToLocalStorage(true);
                    });
                }
            });
            
            sectionElement.appendChild(header);
            sectionElement.appendChild(content);
            
            // Обработчик для переключения секций
            header.addEventListener('click', function() {
                const sectionIndex = this.dataset.sectionIndex;
                const section = document.querySelector(`.section[data-section-index="${sectionIndex}"]`);
                
                if (section.classList.contains('collapsed')) {
                    // Закрыть все секции
                    document.querySelectorAll('.section').forEach(s => {
                        s.classList.remove('expanded');
                        s.classList.add('collapsed');
                    });
                    // Открыть текущую
                    section.classList.remove('collapsed');
                    section.classList.add('expanded');
                } else {
                    // Закрыть текущую
                    section.classList.remove('expanded');
                    section.classList.add('collapsed');
                }
                
                // После открытия секции обновить размер textarea
                setTimeout(() => {
                    setupAutoResizeTextareas();
                }, 100);
            });
            
            container.appendChild(sectionElement);
        });
    }
    
    // Сохранить ответ
    function saveAnswer(sectionIndex, questionIndex, answer, comment = null, additionalInfo = null) {
        if (!answers[sectionIndex]) {
            answers[sectionIndex] = {};
        }
        
        if (!answers[sectionIndex][questionIndex]) {
            answers[sectionIndex][questionIndex] = {};
        }
        
        if (answer !== null) {
            answers[sectionIndex][questionIndex].answer = answer;
        }
        
        if (comment !== null) {
            answers[sectionIndex][questionIndex].comment = comment;
        }
        
        if (additionalInfo !== null) {
            answers[sectionIndex][questionIndex].additionalInfo = additionalInfo;
        }
    }
    
    // Обновить статус секции
    function updateSectionStatus(sectionIndex) {
        const section = document.querySelector(`.section[data-section-index="${sectionIndex}"]`);
        const statusElement = section.querySelector('.section-status');
        
        const totalQuestions = sections[sectionIndex].questions.length;
        const answeredQuestions = section.querySelectorAll('.check-button.checked').length;
        
        statusElement.textContent = `${answeredQuestions}/${totalQuestions}`;
    }
    
    // Обновить прогресс-бар
    function updateProgressBar() {
        const progressBar = document.getElementById('progress');
        
        let totalQuestions = 0;
        let answeredQuestions = 0;
        
        sections.forEach((section, index) => {
            totalQuestions += section.questions.length;
            
            if (answers[index]) {
                answeredQuestions += Object.keys(answers[index]).length;
            }
        });
        
        const progressPercentage = (answeredQuestions / totalQuestions) * 100;
        progressBar.style.width = `${progressPercentage}%`;
    }
    
    // Сохранить в LocalStorage
    function saveToLocalStorage(silent = false) {
        const timestamp = document.getElementById('timestamp').value;
        const data = {
            timestamp: timestamp,
            answers: answers,
            lastSaved: new Date().toLocaleString('ru-RU')
        };
        
        localStorage.setItem('medical_checklist_data', JSON.stringify(data));
        lastSaveTime = new Date();
        
        if (!silent) {
            alert('Данные сохранены в браузере!');
        }
        
        updateAutoSaveStatus();
    }
    
    // Обновить статус автосохранения
    function updateAutoSaveStatus() {
        const statusElement = document.getElementById('auto-save-status');
        if (lastSaveTime) {
            const timeString = lastSaveTime.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            statusElement.textContent = `Сохранено: ${timeString}`;
        }
    }
    
    // Загрузить из LocalStorage
    function loadFromLocalStorage() {
        const savedData = localStorage.getItem('medical_checklist_data');
        if (savedData) {
            const data = JSON.parse(savedData);
            answers = data.answers || {};
            
            // Восстановить ответы в интерфейсе
            Object.keys(answers).forEach(sectionIndex => {
                Object.keys(answers[sectionIndex]).forEach(questionIndex => {
                    const answerData = answers[sectionIndex][questionIndex];
                    const questionElement = document.querySelector(`[data-question-id="${sectionIndex}-${questionIndex}"]`);
                    
                    if (questionElement && answerData.answer === 'Проверено') {
                        const checkButton = questionElement.querySelector('.check-button');
                        if (checkButton) {
                            checkButton.classList.add('checked');
                            questionElement.classList.add('completed');
                        }
                        
                        if (answerData.comment) {
                            const comment = questionElement.querySelector('.comment');
                            if (comment) {
                                comment.value = answerData.comment;
                            }
                        }
                        
                        if (answerData.additionalInfo) {
                            const additionalInfo = questionElement.querySelector('.additional-info');
                            if (additionalInfo) {
                                additionalInfo.value = answerData.additionalInfo;
                            }
                        }
                    }
                });
                updateSectionStatus(parseInt(sectionIndex));
            });
            
            updateProgressBar();
            updateAutoSaveStatus();
            
            // Обновить размер textarea после загрузки данных
            setTimeout(() => {
                setupAutoResizeTextareas();
            }, 100);
        }
    }
    
    // Очистить форму
    function clearForm() {
        if (confirm('Вы уверены, что хотите очистить всю форму? Все данные будут удалены.')) {
            answers = {};
            localStorage.removeItem('medical_checklist_data');
            
            // Сбросить интерфейс
            document.querySelectorAll('.question').forEach(question => {
                question.classList.remove('completed');
                const checkButtons = question.querySelectorAll('.check-button');
                checkButtons.forEach(button => button.classList.remove('checked'));
                
                const textareas = question.querySelectorAll('textarea');
                textareas.forEach(textarea => {
                    textarea.value = '';
                    textarea.style.height = '60px';
                });
            });
            
            document.querySelectorAll('.section-status').forEach(status => {
                const sectionIndex = status.closest('.section').dataset.sectionIndex;
                status.textContent = `0/${sections[sectionIndex].questions.length}`;
            });
            
            updateProgressBar();
            updateAutoSaveStatus();
            
            alert('Форма очищена!');
        }
    }
    
    // Экспорт в Excel (CSV формат)
    function exportToExcel() {
        const timestamp = document.getElementById('timestamp').value;
        let dateStr;
        
        if (timestamp) {
            const date = new Date(timestamp);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            dateStr = `${day}.${month}.${year}`;
        } else {
            const now = new Date();
            dateStr = `${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${now.getFullYear()}`;
        }
        
        // Создаем CSV содержимое
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        
        // Заголовок документа
        csvContent += "Анкета административно-хозяйственного обхода с заведующим хозяйством\r\n";
        csvContent += "ГБУЗ МО МОКПТД\r\n";
        csvContent += "Филиал \"Клинский\"\r\n";
        csvContent += "Клинское отделение\r\n";
        csvContent += `Дата проверки: ${dateStr}\r\n`;
        csvContent += `Дата формирования отчета: ${new Date().toLocaleString('ru-RU')}\r\n\r\n`;
        
        // Добавляем данные по секциям
        sections.forEach((section, sectionIndex) => {
            csvContent += `"${sectionIndex + 1}. ${section.title}"\r\n`;
            csvContent += "№;Вопрос;Статус;Комментарий;Дополнительная информация\r\n";
            
            section.questions.forEach((question, questionIndex) => {
                const answerData = answers[sectionIndex] && answers[sectionIndex][questionIndex];
                const answer = answerData && answerData.answer ? answerData.answer : 'Не проверено';
                const comment = answerData && answerData.comment ? answerData.comment : '';
                const additionalInfo = answerData && answerData.additionalInfo ? answerData.additionalInfo : '';
                
                // Экранируем кавычки в тексте
                const escapedQuestion = question.replace(/"/g, '""');
                const escapedComment = comment.replace(/"/g, '""');
                const escapedAdditionalInfo = additionalInfo.replace(/"/g, '""');
                
                csvContent += `${questionIndex + 1};"${escapedQuestion}";"${answer}";"${escapedComment}";"${escapedAdditionalInfo}"\r\n`;
            });
            
            csvContent += "\r\n";
        });
        
        // Создаем ссылку для скачивания
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `анкета_хозяйственного_обхода_${dateStr.replace(/\./g, '-')}.csv`);
        
        // Добавляем ссылку в документ и кликаем по ней
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Обновляем статус
        const statusElement = document.getElementById('auto-save-status');
        const now = new Date().toLocaleTimeString('ru-RU', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        statusElement.textContent = `Экспортировано: ${now}`;
    }
</script>
</body>
</html>
